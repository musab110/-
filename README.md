# -
مشروع مقرر رسم بالحاسوب 
# مشروع توليد رسومات الأشكال الهندسية باستخدام Stable Diffusion و LoRA (Arabic Shapes Drawing Generator with SD & LoRA)

## مقدمة

هذا المشروع يستخدم Google Colab لتدريب نموذج Stable Diffusion باستخدام تقنية LoRA (Low-Rank Adaptation) لتوليد صور لأشكال هندسية (مربعات، دوائر، مثلثات) في مواقع محددة بناءً على أوامر نصية باللغة العربية. يتضمن المشروع خطوات لتوليد بيانات تدريب اصطناعية، تدريب نموذج LoRA، ثم استخدام النموذج المدرب لتوليد صور جديدة.

## المتطلبات

*   حساب Google (لـ Google Colab و Google Drive).
*   مساحة كافية في Google Drive (لنماذج Stable Diffusion والبيانات والمخرجات).
*   معرفة أساسية بـ Google Colab وبيثون.

## خطوات الإعداد والتشغيل في Google Colab

افتح دفتر ملاحظات Google Colab الخاص بك وقم بتشغيل الخلايا بالترتيب التالي:

---

### **الخلية 0: إعادة ربط Google Drive وتغيير الدليل (Mandatory)**

**الغرض:**
تقوم هذه الخلية بإعادة ربط Google Drive بقوة للتأكد من اتصال مستقر وتحديد دليل العمل الأساسي للمشروع داخل Drive. هذا ضروري لضمان حفظ البيانات والنماذج في مكانها الصحيح.

**تعليمات:**
1.  تأكد من تحديد `PROJECT_BASE_IN_DRIVE` (اسم مجلد المشروع الجديد) بشكل صحيح (افتراضياً: `project_computer_drawing_v6_3k`).
2.  قم بتشغيل الخلية.
3.  قد يُطلب منك السماح لـ Google Colab بالوصول إلى Google Drive.
4.  **انتظر** حتى تكتمل الخلية بنجاح وتظهر الرسالة: `✅ Final CWD check passed. Ready for next steps.`

---

### **الخلية 1: تثبيت المكتبات (Libraries Installation)**

**الغرض:**
تقوم هذه الخلية بتثبيت جميع مكتبات Python اللازمة لتشغيل المشروع (مثل `diffusers`, `transformers`, `accelerate`, `peft`, `torch`, `Pillow`, `tqdm`).

**تعليمات:**
1.  قم بتشغيل الخلية.
2.  يجب أن ترى رسالة: `✅ Libraries seem to be already installed...` إذا تم تشغيلها مسبقًا، أو رسائل التثبيت إذا كانت تُثبت لأول مرة.
3.  **ملاحظة هامة:** إذا كانت هذه هي المرة الأولى التي تقوم فيها بتشغيل هذه الخلية في جلسة Colab جديدة، فقد تحتاج **لإعادة تشغيل بيئة التشغيل (Runtime -> Restart runtime)** بعد اكتمال التثبيت، ثم **تخطي هذه الخلية والخلية 0** والبدء من الخلية 2 مباشرة.

---

### **الخلية 2: الإعدادات العامة والمسارات (General Settings & Paths)**

**الغرض:**
تُعرف هذه الخلية الإعدادات العامة للمشروع، مثل العدد الإجمالي للصور التي سيتم توليدها، حجم الصورة، ومسارات المجلدات المهمة لنموذج Stable Diffusion الأساسي ومخرجات LoRA.

**تعليمات:**
1.  قم بتشغيل الخلية.
2.  **الأهم:**
    *   تأكد أن المخرجات تظهر `Using device: cuda`.
    *   **تحقق جيدًا من المسار `LOCAL_SD_MODEL_PATH`**: يجب أن يشير إلى مجلد نموذج Stable Diffusion الأساسي `stable-diffusion-v1-4` الموجود لديك في Google Drive (مثلاً: `/content/drive/MyDrive/NewProject/stable_diffusion_lora/stable-diffusion-v1-4`). إذا لم يكن موجودًا، ستقوم الخلية 4 بتنزيله، ولكن من الأفضل التحقق من المسار.
    *   `LORA_OUTPUT_DIR_NEW`: هذا هو المجلد الذي سيتم حفظ أوزان LoRA المدربة فيه.

---

### **الخلية 3: توليد البيانات الاصطناعية (Synthetic Data Generation)**

**الغرض:**
تقوم هذه الخلية بتوليد مجموعات من صور الأشكال الهندسية مع أوصاف نصية عربية مطابقة (مثلاً "ارسم مربع في الموقع 50 , 50"). يتم حفظ هذه البيانات في Google Drive واستخدامها لتدريب نموذج LoRA.

**تعليمات:**
1.  قم بتشغيل الخلية.
2.  سيظهر شريط تقدم `Generating Data` أثناء توليد الصور.
3.  عند الانتهاء، ستظهر رسالة: `✅ Data generation complete. Total items in metadata: [عدد الصور]`، بالإضافة إلى عدد ملفات PNG و TXT.

---

### **الخلية 4: تحميل نموذج Stable Diffusion الأساسي (Load Base Stable Diffusion Model)**

**الغرض:**
تقوم هذه الخلية بتحميل مكونات نموذج Stable Diffusion v1.4 الأساسي (tokenizer, text_encoder, vae, unet, noise_scheduler). إذا لم يكن النموذج موجودًا في المسار المحدد في `LOCAL_SD_MODEL_PATH` (الذي حددته في الخلية 2)، فسيتم تنزيله تلقائيًا من Hugging Face وحفظه هناك.

**تعليمات:**
1.  قم بتشغيل الخلية.
2.  إذا كان النموذج موجودًا، سترى رسالة `✅ Found SD model... Loading components...`.
3.  إذا لم يكن موجودًا، سترى رسالة `⬇️ SD model not found... Attempting to download...`، وقد يستغرق التنزيل بعض الوقت.
4.  **انتظر** حتى تظهر الرسالة: `✅ All SD components loaded successfully for training.` و `Models moved to cuda.`

---

### **الخلية 5: إعداد LoRA وتجهيز البيانات للتدريب (LoRA Setup & Data Preparation)**

**الغرض:**
تُعد هذه الخلية نموذج LoRA (Low-Rank Adaptation) الذي سيتم تدريبه. كما تقوم بتحميل البيانات الاصطناعية التي تم إنشاؤها في الخلية 3 وإعداد `DataLoader` للتدريب. تتحقق هذه الخلية أيضًا مما إذا كانت هناك أوزان LoRA محفوظة مسبقًا لاستئناف التدريب.

**تعليمات:**
1.  قم بتشغيل الخلية.
2.  ستقوم الخلية بطباعة معلومات حول إعداد LoRA والمعلمات القابلة للتدريب (`print_trainable_parameters`).
3.  إذا كانت هناك أوزان LoRA سابقة، فستحاول تحميلها واستئناف التدريب من آخر دورة.
4.  سترى رسالة `✅ Dataset created with [عدد] samples.` و `✅ DataLoader created...`

---

### **الخلية 6: تدريب LoRA (LoRA Training)**

**الغرض:**
هذه هي خلية التدريب الفعلية. تقوم بتدريب نموذج LoRA باستخدام البيانات الاصطناعية المحضرة. ستلاحظ شريط تقدم يوضح خسارة التدريب لكل دورة.

**تعليمات:**
1.  **تحقق من الإعدادات:**
    *   `LEARNING_RATE`: معدل التعلم.
    *   `TOTAL_TARGET_EPOCHS`: العدد الإجمالي للدورات التدريبية المستهدفة.
    *   `SAVE_EVERY_N_EPOCHS`: عدد الدورات الفاصلة بين كل عملية حفظ للنموذج.
2.  قم بتشغيل الخلية.
3.  ستشاهد شريط تقدم لكل دورة تدريبية يوضح "Loss".
4.  عند الانتهاء من كل `SAVE_EVERY_N_EPOCHS`، سيتم حفظ أوزان LoRA في مجلد `LORA_OUTPUT_DIR_NEW` (داخل مجلد `epoch_X`).
5.  قد يستغرق التدريب وقتًا طويلاً حسب عدد الدورات ونوع بيئة التشغيل (GPU).

---

### **الخلية 7/8/9: توليد الصور باستخدام أوزان LoRA (Image Generation with LoRA Weights)**

**(يمكنك استخدام أي من هذه الخلايا، فالخلية 8 هي الأكثر مرونة وتتضمن رسم نقطة مرجعية، والخلية 7/9 هي أبسط)**

**الغرض:**
تستخدم هذه الخلايا أوزان LoRA المدربة (من الخلية 6) مع نموذج Stable Diffusion الأساسي لتوليد صور جديدة بناءً على أوامر نصية محددة.

**تعليمات:**
1.  **تأكد من تشغيل الخلايا 0، 2، و 4 بنجاح في هذه الجلسة قبل تشغيل هذه الخلية.**
2.  **الإعدادات الهامة (داخل الكود):**
    *   `LORA_EPOCH_TO_LOAD_FOR_GENERATION`: قم بتعيين هذا المتغير إلى رقم الدورة التي تريد استخدام أوزانها (مثلاً: `11` إذا كانت هي الدورة الأخيرة). إذا تركته `None`، فسيحاول الكود تلقائيًا تحميل أحدث دورة محفوظة.
    *   `YOUR_PROMPTS_FOR_GENERATION`: قم بتعديل هذه القائمة لوضع الأوامر النصية التي تريد توليد صور لها (مثلاً: `["ارسم مربع في الموقع 50 , 50", "ارسم دائرة في الموقع 100 , 100"]`).
    *   يمكنك أيضًا تعديل `NUM_INFERENCE_STEPS_GEN` و `GUIDANCE_SCALE_GEN` و `USE_FIXED_SEED` و `SEED_VALUE` للتحكم في عملية التوليد.
3.  قم بتشغيل الخلية.
4.  سيقوم الكود بتحميل النموذج الأساسي وتطبيق أوزان LoRA، ثم توليد الصور واحدة تلو الأخرى.
5.  سيتم حفظ الصور المولدة في مجلد فرعي داخل `LORA_OUTPUT_DIR_NEW` وعرضها مباشرة في مخرجات Colab.
6.  **ملاحظة:** تم تعطيل مدقق الأمان (`safety_checker = None`) للسماح بتوليد أي صور دون حظر.

---

## ملاحظات هامة واستكشاف الأخطاء وإصلاحها

*   **فشل ربط Drive:** إذا واجهت مشكلة في الخلية 0، تحقق من أذونات Google Drive وإعادة تشغيل جلسة Colab.
*   **"Colab is waiting for authorisation from GitHubError":** هذا الخطأ غير مرتبط بشكل مباشر بهذا الدفتر لأنه لا يستخدم GitHub للمصادقة أثناء التدريب/التوليد. عادةً ما يشير إلى أنك تحاول الاتصال بـ GitHub من Colab ولديك مانع نوافذ منبثقة مفعّل في متصفحك يمنع نافذة المصادقة من الظهور.
*   **تحقق من المسارات:** تأكد دائمًا من أن المسارات مثل `LOCAL_SD_MODEL_PATH` و `FULL_PROJECT_PATH_GDRIVE` صحيحة وتشير إلى المجلدات المتوقعة في Google Drive.
*   **إعادة تشغيل بيئة التشغيل (Runtime):** في بعض الأحيان، خاصة بعد تثبيت مكتبات جديدة، قد يكون من الضروري إعادة تشغيل بيئة التشغيل (Runtime -> Restart runtime) لحل المشكلات الغريبة.
*   **ذاكرة GPU:** قد تحتاج إلى اشتراك Colab Pro أو Pro+ للحصول على وحدات GPU أقوى لتدريب أسرع أو لمجموعات بيانات أكبر.
